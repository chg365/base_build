user nobody nobody;

worker_processes 8;
worker_rlimit_nofile  8192;

#error_log LOG_DIR/nginx/error.log notice;
error_log LOG_DIR/nginx/error.log info;

pid RUN_DIR/nginx/nginx.pid;

events {
    #use epoll;
    worker_connections 1024;
}

http {
	server_tokens off;
    include mime.types;
    index index.php index.html index.htm

	upload_progress proxied 10m;
    default_type  application/octet-stream;
    server_tokens build;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  LOG_DIR/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  60;

	add_header X-Frame-Options SAMEORIGIN;
    gzip  on;
	gzip_proxied expired no-cache no-store private auth;
	gzip_types text/plain text/css text/xml application/javascript application/xml application/rss+xml application/atom+xml;
    gzip_disable "MSIE [1-6]\.(?!.*SV1)";

	client_body_temp_path BODY_TEMP_PATH 1 2;

	proxy_temp_path PROXY_TEMP_PATH 1 2;
	fastcgi_temp_path FASTCGI_TEMP_PATH 1 2;
	uwsgi_temp_path UWSGI_TEMP_PATH 1 2;
	scgi_temp_path SCGI_TEMP_PATH 1 2;

	geoip2 GEOIP2_DATA_DIR/GeoLite2-Country.mmdb {
        #$geoip2_data_country_code default=CN source=$variable_with_ip country iso_code;
		$geoip2_data_country_code default=CN country iso_code;
		$geoip2_data_country_name country names zh-CN;
	}
	geoip2 GEOIP2_DATA_DIR/GeoLite2-City.mmdb {
		$geoip2_data_city_name default=北京 city names zh-CN;
	}

	fastcgi_param COUNTRY_CODE $geoip2_data_country_code;
	fastcgi_param COUNTRY_NAME $geoip2_data_country_name;
	fastcgi_param CITY_NAME    $geoip2_data_city_name;

    server {
		# 启用时将在error log中记录notice级别的重写日志。
		rewrite_log on;
        listen 80;
		listen 443 default_server ssl http2;
        server_name PROJECT_NAME;

        charset UTF-8;

		root WEB_ROOT_DIR;

		location / {
            try_files $uri /index.php$is_args$args;
		}

        # 常用的静态文件
		location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ {
			try_files $uri =404;
		}

        #location /upload {
            #upload_pass   /php/upload.php;

            #upload_store /tmp/upload 1;

            #upload_store_access user:r;

            #upload_set_form_field "${upload_field_name}_name" $upload_file_name;
            #upload_set_form_field "${upload_field_name}_content_type" $upload_content_type;
            #upload_set_form_field "${upload_field_name}_path" $upload_tmp_path;

            #upload_aggregate_form_field "${upload_field_name}_sha1" $upload_file_md5;
            #upload_aggregate_form_field "${upload_field_name}_size" $upload_file_size;

            #upload_pass_form_field "^submit$|^description$";
        #}

        #rewrite "^/([^?]+(?:\.php){0})(\?(.*)){0,1}$" /$1.php$2 last;

        location ~ \.php$ {
            #root WEB_ROOT_DIR;
            fastcgi_buffer_size 128k;
            fastcgi_buffers 8 128k;
            client_max_body_size         500M;
            client_body_buffer_size      2048k;

            fastcgi_pass 127.0.0.1:9040;

            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;

			track_uploads  proxied 30s;
        }

        # upload progress status query
		location ^~ /upload_progress {
			upload_progress_json_output;
			report_uploads  proxied;
		}
    }
}
